<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Boutique - Carnet</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; padding: 20px; max-width: 720px; margin: auto; }
    label { display:block; margin-top:12px; }
    select, textarea, input { width:100%; padding:8px; font-size:16px; margin-top:6px; box-sizing:border-box; }
    button { margin-top:12px; padding:10px 16px; font-size:16px; }
    .sold { color:#999; }
    .message { margin-top:12px; }
  </style>
</head>
<body>
  <h1>Acheter une édition</h1>

  <p>Sélectionnez l'édition que vous voulez acheter, ajoutez un commentaire (facultatif) qui sera enregistré avec le paiement, puis cliquez sur "Payer".</p>

  <form id="buyForm">
    <label for="edition">Édition</label>
    <select id="edition" name="edition">
      <!-- rempli en JS -->
    </select>

    <label for="comment">Commentaire (optionnel)</label>
    <textarea id="comment" name="comment" rows="4" placeholder="Écrire un petit message..."></textarea>

    <label for="email">Email (optionnel, pour rappel)</label>
    <input id="email" name="email" type="email" placeholder="votre@email.com" />

    <button id="payBtn" type="submit">Payer 7.00 CHF</button>
  </form>

  <div class="message" id="message"></div>

  <script>
    const editionsToShow = 12; // modifiez si vous avez plus ou moins d'éditions
    const editionSelect = document.getElementById('edition');
    const messageEl = document.getElementById('message');
    const payBtn = document.getElementById('payBtn');

    // Remplir la liste d'éditions
    function populateEditions(sold = []) {
      editionSelect.innerHTML = '';
      for (let i = 1; i <= editionsToShow; i++) {
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = `édition #${i}`;
        if (sold.includes(i)) {
          opt.disabled = true;
          opt.textContent += ' — VENDUE';
          opt.classList.add('sold');
        }
        editionSelect.appendChild(opt);
      }
    }

    // Charger éditions vendues depuis le serveur
    async function loadSold() {
      try {
        const res = await fetch('/sold-editions');
        if (!res.ok) throw new Error('Erreur lors du chargement des éditions vendues');
        const sold = await res.json();
        populateEditions(sold);
      } catch (err) {
        console.error(err);
        populateEditions([]);
      }
    }

    loadSold();

    // Handler du submit
    document.getElementById('buyForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      messageEl.textContent = '';
      payBtn.disabled = true;
      payBtn.textContent = 'Redirection...';

      const edition = editionSelect.value;
      const comment = document.getElementById('comment').value || '';
      // email n'est pas directement utilisé côté serveur pour Stripe (Stripe collectera l'email via checkout),
      // mais on peut l'envoyer si tu veux le stocker dans metadata (attention à la taille).
      const email = document.getElementById('email').value || '';

      try {
        const res = await fetch('/create-checkout-session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ edition: edition, comment: comment, email: email })
        });
        const data = await res.json();
        if (!res.ok) {
          throw new Error(data.error || 'Erreur création session');
        }

        // On redirige vers l'URL de Stripe Checkout fournie par le serveur
        if (data.url) {
          window.location = data.url;
        } else if (data.id) {
          // fallback
          window.location = `https://checkout.stripe.com/pay/${data.id}`;
        } else {
          throw new Error('Pas d\'URL de session retournée');
        }
      } catch (err) {
        console.error(err);
        messageEl.textContent = 'Erreur : ' + (err.message || err);
        payBtn.disabled = false;
        payBtn.textContent = 'Payer 7.00 CHF';
      }
    });
  </script>
</body>
</html>
