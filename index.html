<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Choose your book :)</title>
  <style>
    body {
      font-family: Helvetica, sans-serif;
      margin: 2rem;
      background-color: #ffffff;
      color: #000000;
      text-align: center;
    }
    h1 { margin-bottom: 20px; }

    .grid {
      display: grid;
      grid-template-columns: repeat(20, 40px);
      grid-gap: 4px;
      justify-content: center;
    }

    .edition {
      width: 40px;
      height: 40px;
      background-color: black;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 12px;
      border: 1px solid #333;
      user-select: none;
      transition: all 0.2s;
    }

    /* Éditions vendues : carrés blancs, texte blanc, non-cliquables */
    .edition.sold {
      background-color: #ffffff;
      color: #ffffff;
      border: 1px solid #fff;
      cursor: not-allowed;
    }

    .edition:hover:not(.sold) {
      transform: scale(1.1);
    }

    #selectedEdition {
      margin-top: 20px;
      font-size: 18px;
    }

    #payButton {
      margin-top: 10px;
      padding: 12px 30px;
      font-size: 18px;
      background-color: #dd00ff;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.2s;
      display: none;
    }

    #payButton:hover:not(:disabled) {
      background-color: #e600e6;
    }

    #payButton:disabled {
      background-color: #999999;
      cursor: not-allowed;
    }
  </style>
</head>
<body>

<h1>Choose your book :)</h1>
<p>Click on a square to select an edition:</p>

<div class="grid" id="grid"></div>

<div id="selectedEdition">Selected edition: <span id="editionNumber">None</span></div>
<button id="payButton">PAY!</button>

<script src="https://js.stripe.com/v3/"></script>
<script>
  const stripe = Stripe("pk_test_51SYWacEy5ypgX29m3MVYntr0LM73kfAvyUZ97sYRus6kWTW1ZyZ1YwrGGO7he3mfwtIx1VG8iU4uqTkJQe78xp3J00aQrSLadU");
  let selectedEdition = null;

  // Récupérer les éditions vendues depuis le serveur
  async function fetchSoldEditions() {
    try {
      const res = await fetch('/sold-editions');
      if (!res.ok) {
        console.error('Failed to fetch sold editions', res.status);
        return [];
      }
      const data = await res.json();
      return data.map(x => Number(x));
    } catch (err) {
      console.error('Error fetching sold editions:', err);
      return [];
    }
  }

  // Générer la grille
  async function generateGrid() {
    const sold = await fetchSoldEditions();
    const grid = document.getElementById('grid');

    for (let i = 1; i <= 200; i++) {
      const div = document.createElement('div');
      div.classList.add('edition');
      div.textContent = i;
      div.dataset.edition = i;

      if (sold.includes(i)) {
        div.classList.add('sold');
      }

      div.addEventListener('click', () => {
        if(div.classList.contains('sold')) return;

        // Désélectionner tous les non-vendus
        document.querySelectorAll('.edition:not(.sold)').forEach(e => e.style.borderColor = '#333');

        // Sélectionner celui cliqué
        div.style.borderColor = '#fff';
        selectedEdition = i;
        document.getElementById('editionNumber').textContent = i;
        document.getElementById('payButton').style.display = 'inline-block';
      });

      grid.appendChild(div);
    }
  }

  generateGrid();

  // Gestion du paiement
  document.getElementById('payButton').addEventListener('click', async () => {
    if (!selectedEdition) return;

    try {
      const response = await fetch('/create-checkout-session', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ edition: selectedEdition }) // plus de prompt pour commentaire
      });

      const session = await response.json();

      if(session.error){
        alert(session.error);
        return;
      }

      if (session.url) {
        window.location.href = session.url;
      } else {
        const result = await stripe.redirectToCheckout({ sessionId: session.id });
        if (result.error) alert(result.error.message);
      }

    } catch (err) {
      console.error('Error:', err);
      alert('An error occurred: ' + err.message);
    }
  });
</script>

</body>
</html>
